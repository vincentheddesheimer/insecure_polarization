### LISS income transformation


rm(list=ls())

# packages
library(data.table)
library(tidyverse)
library(readstata13)
library(furrr)
library(lubridate)


# use multisession evaluation
plan(multisession)

# set wd
setwd("~/Dropbox (Princeton)/Data/Panel_Surveys/LISS/income/")

# read .dta files 
inc <- 
  # list all .dta files in directory
  list.files(pattern = "*.dta") |>
  # read all .dta files in directory
  future_map(~read.dta13(.)) |>
  # delete first five characters of all variable names starting with c
  future_map(~rename_with(.,str_sub, start = 6L, .cols = starts_with("c"))) |>
  # delete first first characters of all variable names starting with _
  future_map(~rename_with(.,str_sub, start = 2L, .cols = starts_with("_"))) |>
  # every column to character
  future_map(~mutate(.x, across(everything(), as.character))) |>
  # bind all data frames
  bind_rows() |>
  # create year and month variable
  mutate(year = year(ym(m)),
         month = month(ym(m)),
         wave = str_sub(start=3L, year)) |>
  # select & rename
  select(nomem_encr:nohouse_encr,
         wave,
         date = m,
         year, month,
         hh_position_i = `001`,
         occupation_i = `383`,
         age_i = `002`,
         birth_year_i = `326`,
         partner_i = `003`,
         work_bin = `004`,
         life_ladder = `005`,
         sat_fin_sit = `006`,
         sat_econ_sit_NED = `007`,
         employee_income = `008`,
         employers_no = `009`,
         gross_wage_1 = `010`,
         gross_wage_1_2 = `372`,
         gross_wage_2 = `019`,
         gross_wage_3 = `028`,
         gross_wage_1_cat = `011`,
         gross_wage_1_cat_2 = `373`,
         gross_wage_2_cat = `020`,
         gross_wage_3_cat = `029`,
         net_wage_1 = `012`,
         net_wage_2 = `021`,
         net_wage_3 = `030`,
         source_tax_form_1 = `013`,
         source_tax_form_2 = `022`,
         source_tax_form_3 = `031`,
         source_tax_report_1 = `014`,
         source_tax_report_2 = `023`,
         source_tax_report_3 = `032`,
         source_salary_slip_1 = `015`,
         source_salary_slip_2 = `024`,
         source_salary_slip_3 = `033`,
         source_other_1 = `016`,
         source_other_2 = `025`,
         source_other_3 = `034`,
         source_none_1 = `017`,
         source_none_2 = `026`,
         source_none_3 = `035`,
         source_other_str_1 = `018`,
         source_other_str_2 = `027`,
         source_other_str_3 = `036`,
         w_freelancer = `037`,
         w_freelancer_job = `038`,
         w_self_employed = `039`,
         w_company_owner = `040`,
         w_partnership = `041`,
         w_partner = `042`,
         w_priv_lim_liab = `043`,
         w_other_enterprise = `044`,
         w_none = `045`,
         g_income_know = `046`,
         g_income_pos_neg = `047`,
         g_income_pos_neg_exp = `048`,
         g_income = `049`,
         g_income_exp = `050`,
         g_income_cat = `051`,
         g_income_source_taxform = `052`,
         g_income_source_other = `053`,
         g_income_source_none = `054`,
         g_income_source_other_str = `055`,
         tax_deduc_bin = `056`,
         tax_deduc = `057`,
         tax_deduc_exp = `058`,
         self_empl_last_year = `059`,
         g_income_last_year_pos_neg = `060`,
         g_income_last_year = `061`,
         g_income_last_year_cat = `062`,
         tax_deduc_last_year_bin = `063`,
         tax_deduc_last_year = `064`,
         p_bin = `065`,
         p_early_retirement = `066`,
         p_early_retirement_2 = `363`,
         p_state_pension = `067`,
         p_other = `068`,
         p_life_annuity = `069`,
         p_noneabove = `070`,
         p_sep_fund = `071`,
         p_early_retirement_gross = `072`,
         p_early_retirement_gross_2 = `364`,
         p_early_retirement_cat = `073`,
         p_early_retirement_cat_2 = `365`,
         p_early_retirement_net = `074`,
         p_early_retirement_net_2 = `366`,
         p_state_pension_gross = `076`,
         p_state_pension_cat = `077`,
         p_state_pension_net = `078`,
         p_state_pension_gross_2 = `367`,
         p_state_pension_cat_2 = `368`,
         p_state_pension_net_2 = `369`,
         p_other_gross = `080`,
         p_other_cat = `081`,
         p_other_net = `082`,
         p_life_annuity_gross = `084`,
         p_life_annuity_cat = `085`,
         p_life_annuity_net = `086`,
         b_sickness = `087`,
         b_unempl = `088`,
         b_unempl_2 = `374`,
         b_halfpay = `089`,
         b_surv_relatives = `090`,
         b_rel_pension = `091`,
         b_orphan_pension = `092`,
         b_work_ass_act = `093`,
         b_work_ass_act_2 = `341`,
         b_selfempl = `094`,
         b_old_disable = `095`,
         b_disable = `096`,
         b_part_disable = `097`,
         b_invalidity = `098`,
         b_child = `099`,
         b_healthcare = `100`,
         b_child_toeslag = `323`,
         b_child_budget = `327`,
         b_disable_young = `328`,
         b_old_unempl = `329`,
         b_old_add = `393`,
         b_none = `101`,
         b_sickness_gross = `102`,
         b_sickness_cat = `103`,
         b_sickness_net = `104`,
         b_unempl_gross = `105`,
         b_unempl_cat = `106`,
         b_unempl_net = `107`,
         b_unempl_gross_2 = `375`,
         b_unempl_cat_2 = `376`,
         b_halfpay_gross = `108`,
         b_halfpay_cat = `109`,
         b_halfpay_net = `110`,
         b_surv_relatives_gross = `111`,
         b_surv_relatives_cat = `112`,
         b_surv_relatives_net = `113`,
         b_rel_pension_gross = `114`,
         b_rel_pension_cat = `115`,
         b_rel_pension_net = `116`,
         b_orphan_pension_gross = `117`,
         b_orphan_pension_cat = `118`,
         b_orphan_pension_net = `119`,
         b_work_ass_act_gross = `120`,
         b_work_ass_act_gross_2 = `342`,
         b_work_ass_act_cat = `121`,
         b_work_ass_act_cat_2 = `343`,
         b_work_ass_act_net = `122`,
         b_work_ass_act_net_2 = `344`,
         b_selfempl_gross = `123`,
         b_selfempl_cat = `124`,
         b_selfempl_cat_2 = `369`,
         b_selfempl_net = `125`,
         b_old_disable_gross = `126`,
         b_old_disable_cat = `127`,
         b_old_disable_net = `128`,
         b_disable_gross = `129`,
         b_disable_cat = `130`,
         b_disable_net = `131`,
         b_part_disable_gross = `132`,
         b_part_disable_cat = `133`,
         b_part_disable_net = `134`,
         b_invalidity_gross = `135`,
         b_invalidity_cat = `136`,
         b_invalidity_net = `137`,
         b_child_gross = `140`,
         b_healthcare_net = `143`,
         b_child_toeslag_net= `324`,
         b_child_budget_net = `330`,
         b_disable_young_gross = `331`,
         b_disable_young_cat = `332`,
         b_disable_young_cat_2 = `370`,
         b_disable_young_net = `333`,
         b_old_unempl_gross = `334`,
         b_old_unempl_cat = `335`,
         b_old_unempl_cat_2 = `371`,
         b_old_unempl_net = `336`,
         b_old_add_net = `394`,
         i_real_estate = `144`,
         i_house_ownership_grant = `145`,
         i_student_grant = `146`,
         i_student_loan = `147`,
         i_alimony_ex = `148`,
         i_alimony_child = `149`,
         i_study_allow_parents = `150`,
         i_allow_parents = `151`,
         i_dividens = `152`,
         i_interest = `153`,
         i_crypto = `395`,
         i_none = `154`,
         i_real_estate_val = `155`,
         i_real_estate_cat = `156`,
         i_house_ownership_grant_val = `157`,
         i_house_ownership_grant_cat = `158`,
         i_student_grant_val = `159`,
         i_student_grant_cat = `160`,
         i_student_loan_gross = `161`,
         i_student_loan_cat = `162`,
         i_alimony_ex_gross = `163`,
         i_alimony_ex_cat = `164`,
         i_alimony_child_gross = `165`,
         i_alimony_child_cat = `166`,
         i_study_allow_parents_gross = `167`,
         i_study_allow_parents_cat = `168`,
         i_allow_parents_gross = `169`,
         i_allow_parents_cat = `170`,
         i_dividens_gross = `171`,
         i_dividens_cat = `172`,
         i_interest_gross = `173`,
         i_interest_cat = `174`,
         i_crypto_gross = `396`,
         i_crypto_cat = `397`,
         i_covid_scheme = `386`,
         i_covid_scheme_NOW = `387`,
         i_covid_scheme_Tozo = `388`,
         i_covid_scheme_TONK = `389`,
         i_covid_scheme_TOGS = `390`,
         i_covid_scheme_TVL = `391`,
         i_covid_scheme_other = `392`,
         legacies_gifts = `175`,
         legacies_gifts_val = `176`,
         legacies_gifts_cat = `325`,
         i_former_work = `178`,
         i_pocket_money = `179`,
         i_lottery = `180`,
         i_remunetarion = `181`,
         i_severance = `182`,
         i_repr_allow = `183`,
         i_roaylties = `184`,
         i_damage_comp = `185`,
         i_trainee_comp = `186`,
         i_reimburs = `187`,
         i_voluntary_comp = `188`,
         i_munic_low_inc = `357`,
         i_once_only_allow = `358`,
         i_study_comp = `359`,
         i_other = `189`,
         i_other_str = `190`,
         i_former_work_gross = `191`,
         i_pocket_money_gross = `192`,
         i_lottery_gross = `193`,
         i_remunetarion_gross = `194`,
         i_severance_gross = `195`,
         i_repr_allow_gross = `196`,
         i_roaylties_gross = `197`,
         i_damage_comp_gross = `198`,
         i_trainee_comp_gross = `199`,
         i_reimburs_gross = `200`,
         i_voluntary_comp_gross = `201`,
         i_munic_low_inc_gross = `360`,
         i_once_only_allow_gross = `361`,
         i_study_comp_gross = `362`,
         i_other_gross = `202`,
         i_otherforms_tot = `384`,
         i_otherforms_cat = `385`,
         c_loans_pay_bin = `203`,
         c_loans_pay_val = `204`,
         c_alimony_ex_bin = `205`,
         c_alimony_ex_val = `206`,
         c_alimony_child_bin = `207`,
         c_alimony_child_val = `208`,
         c_stud_support_child_bin = `209`,
         c_stud_support_child_val = `210`,
         c_fin_support_child_bin = `211`,
         c_fin_support_child_val = `212`,
         c_fin_gift_bin = `213`,
         c_fin_gift_val = `214`,
         c_health_insur_period = `215`,
         c_health_insur_myself = `217`,
         c_health_insur_partner = `218`,
         c_health_insur_childr = `219`,
         c_health_insur_tot = `216`,
         car_company = `221`,
         car_company_val = `222`,
         car_company_cat = `223`,
         car_company_months = `224`,
         income_taxable = `225`,
         income_taxable_2 = `337`,
         income_taxable_cat = `226`,
         income_taxable_est = `227`,
         income_taxable_est_2 = `338`,
         income_hh_net = `228`,
         income_hh_net_2 = `339`,
         income_hh_cat = `229`,
         income_hh_verybad = `230`,
         income_hh_bad = `231`,
         income_hh_insuff = `232`,
         income_hh_suff = `233`,
         income_hh_good = `234`,
         income_hh_verygood = `235`,
         income_hh_min = `236`,
         inc_change_stopwork = `237`,
         inc_change_startwork = `238`,
         inc_change_changework = `239`,
         inc_change_promot = `240`,
         inc_change_soc_ben_inc = `241`,
         inc_change_soc_ben_dec = `242`,
         fin_sit_better = `243`,
         fin_sit_better_2 = `377`,
         easy_live_inc = `244`,
         easy_live_inc_2 = `378`,
         confr_trouble_ends_meet = `245`,
         confr_replace_things = `246`,
         confr_lend_money = `247`,
         confr_pay_rent = `248`,
         confr_debt_collector = `249`,
         confr_family_support = `250`,
         confr_none = `251`,
         hh_fin_sat = `252`,
         hh_exp_inc = `253`,
         hh_purchase = `254`,
         hh_exp_inc_wo = `255`,
         pr_lose_job = `256`,
         pr_lose_job_2 = `379`,
         pr_find_job = `257`,
         hh_exp_Inc_next = `258`,
         hh_exp_purchase = `259`,
         hh_exp__inc_next_wo = `260`,
         hh_exp_fin_sat = `261`,
         hh_reduce5per = `262`,
         happy = `263`,
         happy_2 = `380`,
         hh_fin_decis = `264`,
         hh_fin_manag = `265`,
         o_phone = `266`,
         o_mobile = `267`,
         o_smart_phone = `268`,
         o_w_tv = `269`,
         o_d_tv = `270`,
         o_sat_dish = `271`,
         o_home_cine = `272`,
         o_cd = `273`,
         o_dvd_play = `274`,
         o_dvd_rec= `275`,
         o_cd_writ = `276`,
         o_mp3 = `277`,
         o_mp4 = `278`,
         o_camcord = `279`,
         o_pda_wo = `280`,
         o_pda_int = `281`,
         o_pc = `282`,
         o_print = `283`,
         o_photo = `284`,
         o_games = `285`,
         o_gps = `286`,
         o_washdry = `287`,
         o_dishwash = `288`,
         o_freeze = `289`,
         o_microwave = `290`,
         o_fryer = `291`,
         o_w_tv_2 = `346`,
         o_dishwash_2 = `347`,
         o_car = `348`,
         o_phone_home = `349`,
         o_phone_why = `350`,
         o_phone_why_other = `351`,
         arrears_no = `292`,
         arrears_rent_mort = `293`,
         arrears_util = `294`,
         arrears_other = `295`,
         arrears_dontknow = `296`,
         arrears_notsay = `297`,
         arrears_rent_mort_val = `298`,
         arrears_rent_mort_val_2 = `381`,
         arrears_util_val = `299`,
         arrears_other_val = `300`,
         arrears_rent_mort_2m  = `301`,
         arrears_rent_mort_months = `302`,
         arrears_util_2m = `303`,
         arrears_util_months = `304`,
         healthy_meal = `305`,
         healthy_meal_2 = `382`,
         new_clothes = `306`,
         replace_furn = `307`,
         week_holiday = `308`,
         week_holiday_2 = `340`,
         child_schooling = `309`,
         outing_bin = `310`,
         outing_reason = `311`,
         outing_other = `312`,
         dinner_2month = `352`,
         heat_home = `353`,
         club_member = `354`,
         easy_unexp_exp = `355`,
         burden_living_costs = `356`) |>
  # transform double variables
  mutate(income_taxable = ifelse(!is.na(income_taxable),
                                 income_taxable,
                                 income_taxable_2),
         income_taxable_est = ifelse(!is.na(income_taxable_est),
                                     income_taxable_est,
                                     income_taxable_est_2),
         income_hh_net = ifelse(!is.na(income_hh_net),
                                income_hh_net,
                                income_hh_net_2),
         week_holiday = ifelse(!is.na(week_holiday),
                               week_holiday,
                               week_holiday_2),
         b_work_ass_act = ifelse(!is.na(b_work_ass_act),
                                 b_work_ass_act,
                                 b_work_ass_act_2),
         b_work_ass_act_gross = ifelse(!is.na(b_work_ass_act_gross),
                                       b_work_ass_act_gross,
                                       b_work_ass_act_gross_2),
         b_work_ass_act_cat = ifelse(!is.na(b_work_ass_act_cat),
                                     b_work_ass_act_cat,
                                     b_work_ass_act_cat_2),
         b_work_ass_act_net = ifelse(!is.na(b_work_ass_act_net),
                                     b_work_ass_act_net,
                                     b_work_ass_act_net_2),
         p_early_retirement = ifelse(!is.na(p_early_retirement),
                                     p_early_retirement,
                                     p_early_retirement_2),
         p_early_retirement_gross = ifelse(!is.na(p_early_retirement_gross),
                                            p_early_retirement_gross,
                                            p_early_retirement_gross_2),
         p_early_retirement_cat = ifelse(!is.na(p_early_retirement_cat),
                                          p_early_retirement_cat,
                                          p_early_retirement_cat_2),
         p_early_retirement_net = ifelse(!is.na(p_early_retirement_net),
                                          p_early_retirement_net,
                                          p_early_retirement_net_2),
         p_state_pension_gross = ifelse(!is.na(p_state_pension_gross),
                                         p_state_pension_gross,
                                         p_state_pension_gross_2),
         p_state_pension_cat = ifelse(!is.na(p_state_pension_cat),
                                      p_state_pension_cat,
                                      p_state_pension_cat_2),
         p_state_pension_net = ifelse(!is.na(p_state_pension_net),
                                      p_state_pension_net,
                                      p_state_pension_net_2),
         b_selfempl_cat = ifelse(!is.na(b_selfempl_cat),
                                 b_selfempl_cat,
                                 b_selfempl_cat_2),
         b_disable_young_cat = ifelse(!is.na(b_disable_young_cat),
                                      b_disable_young_cat,
                                      b_disable_young_cat_2),
         b_old_unempl_cat = ifelse(!is.na(b_old_unempl_cat),
                                   b_old_unempl_cat,
                                   b_old_unempl_cat_2),
         gross_wage_1 = ifelse(!is.na(gross_wage_1),
                               gross_wage_1,
                               gross_wage_1_2),
         gross_wage_1_cat = ifelse(!is.na(gross_wage_1_cat),
                                   gross_wage_1_cat,
                                   gross_wage_1_cat_2),
         b_unempl = ifelse(!is.na(b_unempl),
                           b_unempl,
                           b_unempl_2),
         b_unempl_gross = ifelse(!is.na(b_unempl_gross),
                                 b_unempl_gross,
                                 b_unempl_gross_2),
         b_unempl_cat = ifelse(!is.na(b_unempl_cat),
                               b_unempl_cat,
                               b_unempl_cat_2),
         fin_sit_better = ifelse(!is.na(fin_sit_better),
                                 fin_sit_better,
                                 fin_sit_better_2),
         easy_live_inc = ifelse(!is.na(easy_live_inc),
                                easy_live_inc,
                                easy_live_inc_2),
         pr_lose_job = ifelse(!is.na(pr_lose_job),
                              pr_lose_job,
                              pr_lose_job_2),
         happy = ifelse(!is.na(happy),
                        happy,
                        happy_2),
         arrears_rent_mort_val = ifelse(!is.na(arrears_rent_mort_val),
                                        arrears_rent_mort_val,
                                        arrears_rent_mort_val_2),
         healthy_meal = ifelse(!is.na(healthy_meal),
                               healthy_meal,
                               healthy_meal_2)
  ) |>
  # delete double variables
  select(-c(gross_wage_1_2,gross_wage_1_cat_2, p_early_retirement_2,
            p_early_retirement_gross_2,p_early_retirement_cat_2,p_early_retirement_net_2,
            p_state_pension_gross_2:p_state_pension_net_2,b_unempl_2,
            b_work_ass_act_2,b_unempl_gross_2,b_unempl_cat_2,
            b_work_ass_act_gross_2,b_work_ass_act_cat_2,b_work_ass_act_net_2,
            b_selfempl_cat_2,b_disable_young_cat_2,b_old_unempl_cat_2,
            income_taxable_2,income_taxable_est_2,income_hh_net_2,
            fin_sit_better_2,easy_live_inc_2,pr_lose_job_2,
            happy_2,arrears_rent_mort_val,healthy_meal_2,week_holiday_2
            )) |>
  # arrange
  arrange(nomem_encr)


# write .csv file
setwd("~/Dropbox (Princeton)/Data/Panel_Surveys/LISS/")
fwrite(inc, file = "liss_income.csv")


### END